<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_delivery_document_custom" inherit_id="stock.report_delivery_document">

        <xpath expr="//div[@t-if='not (o.backorder_ids and backorders)']" position="replace"/>
        <xpath expr="//div[@t-else]" position="replace"/>

        <xpath expr="//table[@name='stock_move_table']" position="attributes">
            <attribute name="t-if"/>
        </xpath>
        <!-- Safe header replacement -->
        <xpath expr="//table[@name='stock_move_table']/thead/tr" position="replace">
            <tr>
                <th style="width:5%; text-align:center;">
                    <strong>NO.</strong>
                </th>
                <th style="text-align:center;">
                    <t t-if="o.picking_type_id.code != 'incoming'">
                        <strong>Description</strong>
                    </t>
                    <t t-else="">
                        <strong>Product</strong>
                    </t>
                </th>
                <th style="text-align:center;">
                    <strong>Delivered</strong>
                </th>
            </tr>
        </xpath>

        <!-- Safe body replacement -->
        <xpath expr="//table[@name='stock_move_table']/tbody" position="replace">
            <tbody>
                <t t-set="lines" t-value="o.move_ids.filtered(lambda x: x.product_uom_qty)"/>
                <t t-set="counter" t-value="1"/>
                <tr t-foreach="lines" t-as="move">
                    <td style="text-align:center;">
                        <t t-esc="counter"/>
                        <t t-set="counter" t-value="counter + 1"/>
                    </td>

                    <td style="text-align:center;">
                        <t t-if="o.picking_type_id.code != 'incoming'">
                            <span t-field="move.description_so"/>
                        </t>
                        <t t-else="">
                            <span t-field="move.product_id.name"/>
                        </t>
                    </td>

                    <td style="text-align:center;">
                        <span t-field="move.quantity"/>
                        <span t-field="move.product_uom"/>
                    </td>
                </tr>
            </tbody>
        </xpath>

        <!-- Format date to only show date -->
        <xpath expr="//div[@name='div_sched_date']/p[@t-field='o.date_done']" position="replace">
            <p t-if="o.state == 'done'" t-field="o.date_done" t-options="{'widget': 'date'}"/>
        </xpath>

        <xpath expr="//div[@name='div_sched_date']/p[@t-field='o.scheduled_date']" position="replace">
            <p t-else="" t-field="o.scheduled_date" t-options="{'widget': 'date'}"/>
        </xpath>

        <xpath expr="//div[@name='div_sched_date']" position="after">

            <div t-if="o.owner_id" class="col-auto" name="div_owner_id">
                <strong>Assign Owner:</strong>
                <p t-field="o.owner_id"/>
            </div>
        </xpath>

        <xpath expr="//table[@name='stock_move_line_table']" position="after">


            <div style="margin-top:50px;">
                <p>
                    <strong>We received the goods according to the specifications.</strong>
                </p>
            </div>
            <div style="margin-top:350px; display: flex; justify-content: flex-start;">
                <p>
                    <strong>Authorized stamp and signature :</strong>
                </p>
            </div>
        </xpath>
        <xpath expr="//table[@name='stock_move_line_table']" position="replace"/>
    </template>
    <record id="view_picking_form_inherit_so_desc" model="ir.ui.view">
        <field name="name">stock.picking.form.so.description</field>
        <field name="model">stock.picking</field>
        <field name="inherit_id" ref="stock.view_picking_form"/>
        <field name="arch" type="xml">
            <!-- ندخل إلى شجرة عمليات التسليم ثم نضيف الحقل بعد product_id -->
            <xpath expr="//field[@name='move_ids_without_package']//tree//field[@name='product_id']"
                   position="after">
                <field name="description_so" readonly="1" column_invisible="1"/>
            </xpath>
        </field>
    </record>
</odoo>
